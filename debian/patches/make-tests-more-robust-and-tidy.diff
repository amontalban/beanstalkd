Author: Serafeim Zanikolas <serzan@hellug.gr>
Forwarded: http://groups.google.com/group/beanstalk-talk/browse_thread/thread/badb729887f4f4d
Last-Update: 2010-02-21

--- a/check.sh
+++ b/check.sh
@@ -1,5 +1,12 @@
 #!/bin/bash
 
+if /sbin/ifconfig | egrep -q '^lo[[:space:]]+Link'; then
+    echo "loopback interface is configured, getting on with tests"
+else
+    echo "loopback interface is NOT configured, won't run tests"
+    exit 0
+fi
+
 one="$(dirname "$0")/check-one.sh"
 
 for commands in "$@"; do
--- a/check-one.sh
+++ b/check-one.sh
@@ -1,7 +1,8 @@
-#!/bin/sh
+#!/bin/bash
+
+. sh-tests/common.functions
 
 server=localhost
-port=11400
 tmpdir="$TMPDIR"
 test -z "$tmpdir" && tmpdir=/tmp
 tmpf="${tmpdir}/bnch$$"
@@ -34,14 +35,7 @@
   exit 2
 fi
 
-./beanstalkd -p $port >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing, port $port is taken"
-  exit 2
-fi
+start_beanstalkd
 
 # Run the test
 fgrep -v "#" $commands | $nc $server $port > "$tmpf"
--- a/sh-tests/binlog-diskfull-delete.sh
+++ b/sh-tests/binlog-diskfull-delete.sh
@@ -1,8 +1,9 @@
 #!/usr/bin/env bash
 
+. sh-tests/common.functions
+
 ENOSPC=28
 server=localhost
-port=11400
 tmpdir="$TMPDIR"
 size=1000
 test -z "$tmpdir" && tmpdir=/tmp
@@ -25,17 +26,9 @@
     exit 1
 }
 
-killbeanstalkd() {
-    {
-        test -z "$bpid" || kill -9 $bpid
-        /bin/true # Somehow this gets rid of an unnessary shell message.
-    } >/dev/null 2>&1
-    bpid=
-}
-
 cleanup() {
     killbeanstalkd
-    rm -rf "$logdir" "$out1" "$out2"
+    rm -rf "$logdir" "$out1" "$out2" ${tmpdir}/fiu-ctrl-[0-9]*.{in,out}
 }
 
 catch() {
@@ -56,16 +49,7 @@
   exit 2
 fi
 
-mkdir -p $logdir
-
-fiu-run -x ./beanstalkd -p $port -b "$logdir" -s $size >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir "-s $size" "fiu-run -x"
 
 # Insert enough jobs to create another binlog file
 $nc $server $port <<EOF > "$out1"
@@ -181,15 +165,7 @@
 
 killbeanstalkd
 
-sleep .1
-./beanstalkd -p $port -b "$logdir" -s $size >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir "-s $size"
 
 $nc $server $port <<EOF > "$out2"
 delete 8
--- a/sh-tests/binlog-diskfull.sh
+++ b/sh-tests/binlog-diskfull.sh
@@ -1,8 +1,9 @@
 #!/usr/bin/env bash
 
+. sh-tests/common.functions
+
 ENOSPC=28
 server=localhost
-port=11400
 tmpdir="$TMPDIR"
 size=1000
 test -z "$tmpdir" && tmpdir=/tmp
@@ -18,17 +19,9 @@
   exit 0
 fi
 
-killbeanstalkd() {
-    {
-        test -z "$bpid" || kill -9 $bpid
-        /bin/true # Somehow this gets rid of an unnessary shell message.
-    } >/dev/null 2>&1
-    bpid=
-}
-
 cleanup() {
     killbeanstalkd
-    rm -rf "$logdir" "$out1" "$out2"
+    rm -rf "$logdir" "$out1" "$out2" ${tmpdir}/fiu-ctrl-[0-9]*.{in,out}
 }
 
 catch() {
@@ -44,16 +37,7 @@
   exit 2
 fi
 
-mkdir -p $logdir
-
-fiu-run -x ./beanstalkd -p $port -b "$logdir" -s $size >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir "-s $size" "fiu-run -x"
 
 # Make beanstalkd think the disk is full now.
 fiu-ctrl -e posix/io/oc/open -i $ENOSPC $bpid
@@ -114,14 +98,7 @@
 killbeanstalkd
 
 sleep .1
-./beanstalkd -p $port -b "$logdir" -s $size >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir "-s $size"
 
 $nc $server $port <<EOF > "$out2"
 delete 1
--- a/sh-tests/binlog-basic.sh
+++ b/sh-tests/binlog-basic.sh
@@ -1,7 +1,8 @@
 #!/usr/bin/env bash
 
+. sh-tests/common.functions
+
 server=localhost
-port=11400
 tmpdir="$TMPDIR"
 test -z "$tmpdir" && tmpdir=/tmp
 out1="${tmpdir}/bnch$$.1"
@@ -10,14 +11,6 @@
 nc='nc -q 1'
 nc -q 1 2>&1 | grep -q "illegal option" && nc='nc -w 1' # workaround for older netcat
 
-killbeanstalkd() {
-    {
-        test -z "$bpid" || kill -9 $bpid
-        /bin/true # Somehow this gets rid of an unnessary shell message.
-    } >/dev/null 2>&1
-    bpid=
-}
-
 cleanup() {
     killbeanstalkd
     rm -rf "$logdir" "$out1" "$out2"
@@ -36,16 +29,7 @@
   exit 2
 fi
 
-mkdir -p $logdir
-
-./beanstalkd -p $port -b "$logdir" >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir
 
 $nc $server $port <<EOF > "$out1"
 put 0 0 100 0
@@ -62,14 +46,7 @@
 killbeanstalkd
 
 sleep .1
-./beanstalkd -p $port -b "$logdir" >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir
 
 $nc $server $port <<EOF > "$out2"
 delete 1
--- a/sh-tests/binlog-sizelimit.sh
+++ b/sh-tests/binlog-sizelimit.sh
@@ -1,7 +1,8 @@
 #!/usr/bin/env bash
 
+. sh-tests/common.functions
+
 server=localhost
-port=11400
 tmpdir="$TMPDIR"
 size=1024
 truncated_size_1=796
@@ -20,14 +21,6 @@
     exit 1
 }
 
-killbeanstalkd() {
-    {
-        test -z "$bpid" || kill -9 $bpid
-        /bin/true # Somehow this gets rid of an unnessary shell message.
-    } >/dev/null 2>&1
-    bpid=
-}
-
 cleanup() {
     killbeanstalkd
     rm -rf "$logdir" "$out1" "$out2"
@@ -51,16 +44,7 @@
   exit 2
 fi
 
-mkdir -p $logdir
-
-./beanstalkd -p $port -b "$logdir" -s $size >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir "-s $size"
 
 # Check that the first binlog file is the proper size.
 test "$(fsize "$logdir"/binlog.1)" -eq $size || fail first binlog wrong size
--- a/sh-tests/binlog-bury.sh
+++ b/sh-tests/binlog-bury.sh
@@ -1,7 +1,8 @@
 #!/usr/bin/env bash
 
+. sh-tests/common.functions
+
 server=localhost
-port=11400
 tmpdir="$TMPDIR"
 test -z "$tmpdir" && tmpdir=/tmp
 out1="${tmpdir}/bnch$$.1"
@@ -10,14 +11,6 @@
 nc='nc -q 1'
 nc -q 1 2>&1 | grep -q "illegal option" && nc='nc -w 1' # workaround for older netcat
 
-killbeanstalkd() {
-    {
-        test -z "$bpid" || kill -9 $bpid
-        /bin/true # Somehow this gets rid of an unnessary shell message.
-    } >/dev/null 2>&1
-    bpid=
-}
-
 cleanup() {
     killbeanstalkd
     rm -rf "$logdir" "$out1" "$out2"
@@ -36,16 +29,7 @@
   exit 2
 fi
 
-mkdir -p $logdir
-
-./beanstalkd -p $port -b "$logdir" >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir
 
 $nc $server $port <<EOF > "$out1"
 put 0 0 100 0
--- a/sh-tests/binlog-read.sh
+++ b/sh-tests/binlog-read.sh
@@ -1,7 +1,8 @@
 #!/usr/bin/env bash
 
+. sh-tests/common.functions
+
 server=localhost
-port=11400
 tmpdir="$TMPDIR"
 test -z "$tmpdir" && tmpdir=/tmp
 out1="${tmpdir}/bnch$$.1"
@@ -10,14 +11,6 @@
 nc='nc -q 1'
 nc -q 1 2>&1 | grep -q "illegal option" && nc='nc -w 1' # workaround for older netcat
 
-killbeanstalkd() {
-    {
-        test -z "$bpid" || kill -9 $bpid
-        /bin/true # Somehow this gets rid of an unnessary shell message.
-    } >/dev/null 2>&1
-    bpid=
-}
-
 cleanup() {
     killbeanstalkd
     rm -rf "$logdir" "$out1" "$out2"
@@ -36,16 +29,7 @@
   exit 2
 fi
 
-mkdir -p $logdir
-
-./beanstalkd -p $port -b "$logdir" >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir
 
 $nc $server $port <<EOF > "$out1"
 use test
@@ -79,14 +63,7 @@
 killbeanstalkd
 
 sleep 1
-./beanstalkd -p $port -b "$logdir" >/dev/null 2>/dev/null &
-bpid=$!
-
-sleep .1
-if ! ps -p $bpid >/dev/null; then
-  echo "Could not start beanstalkd for testing (possibly port $port is taken)"
-  exit 2
-fi
+start_beanstalkd $logdir
 
 $nc $server $port <<EOF > "$out2"
 watch test
--- /dev/null
+++ b/sh-tests/common.functions
@@ -0,0 +1,42 @@
+#!/usr/bin/env bash
+
+start_port=11400
+max_port_retries=20
+
+function killbeanstalkd() {
+    {
+        test -z "$bpid" || kill -9 $bpid
+        /bin/true # Somehow this gets rid of an unnessary shell message.
+    } >/dev/null 2>&1
+}
+
+function start_beanstalkd {
+    port=$start_port
+    logdir="$1"
+    other_args="$2" # other_args and fiu are optional
+    fiu="$3"
+
+    if [ "x$logdir" != "x" ]; then
+        mkdir -p $logdir
+        other_args="-b $logdir $other_args"
+    fi
+
+    max_port=$(($port + $max_port_retries))
+    while [ $port -lt $max_port ]; do
+        echo "$fiu ./beanstalkd -l 127.0.0.1 -p $port $other_args &"
+        $fiu ./beanstalkd -l 127.0.0.1 -p $port $other_args &
+        bpid=$!
+
+        sleep .1
+        if ! ps -p $bpid >/dev/null; then
+          echo "Could not start beanstalkd for testing (possibly port $port is taken)" >&2
+          port=$(($port + 1))
+        else
+          echo "Started beanstalkd (pid: $bpid), listening on port $port"
+          export port bpid
+          return
+        fi
+    done
+  echo "Giving up after having tried $max_port_retries different ports" >&2
+  exit 2
+}
